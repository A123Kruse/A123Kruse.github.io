<script>
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const el = {
    cards: $('#cards'), progress: $('#progress'), score: $('#scorePill'), round: $('#roundPill'),
    reveal: $('#revealBtn'), next: $('#nextBtn'), restart: $('#restartBtn'),
    status: $('#status'), error: $('#error'), categoryNote: $('#categoryNote') || {textContent:''}, aria: $('#ariaLive')
  };

  const state = { rounds: [], i: 0, score: 0, picked: null, shuffleSides: true };
  const params = new URLSearchParams(location.search);
  state.shuffleSides = params.get('shuffle') !== 'false';

  // --- base-aware path (works on username.github.io/<repo>/) ---
  function toURL(p) {
    if (/^(https?:)?\/\//i.test(p)) return p;
    const clean = String(p || '').replace(/^\//,'');
    return new URL(clean, document.baseURI).toString();
  }

  // --- include category when needed (Option A we used before) ---
  function resolveSrc(entry, label, category){
    const v = typeof entry === 'string' ? entry : (entry?.file ?? entry?.src ?? '');
    if (!v) return '';
    if (/^(https?:)?\/\//i.test(v)) return v;                  // full URL
    if (v.startsWith('/')) return toURL(v);                    // "/images/real/animals/x.jpg"
    if (v.startsWith('images/')) return toURL(v);              // "images/real/animals/x.jpg"
    if (v.includes('/')) return toURL(v);                      // "animals/x.jpg"
    const folder = label === 'ai' ? 'images/ai' : 'images/real';
    const cat = category ? `/${category}` : '';
    return toURL(`${folder}${cat}/${v}`);                      // "images/real/animals/x.jpg"
  }

  function autoAlt(x){ const s = typeof x==='string'?x:(x?.file??x?.src??''); return String(s).split('/').pop().replace(/\.[a-z0-9]+$/i,'').replace(/[-_]/g,' '); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  function buildRoundsFromCategorizedManifest(m){
    const rounds = [];
    for(const cat of Object.keys(m||{})){
      const real = Array.isArray(m[cat]?.real) ? [...m[cat].real] : [];
      const ai   = Array.isArray(m[cat]?.ai)   ? [...m[cat].ai]   : [];
      shuffle(real); shuffle(ai);
      const n = Math.min(real.length, ai.length);
      for(let k=0;k<n;k++){
        const rEnt = real[k], aEnt = ai[k];
        rounds.push({
          category: cat,
          images: [
            { src: resolveSrc(rEnt, 'real', cat), label: 'real', alt: autoAlt(rEnt) },
            { src: resolveSrc(aEnt, 'ai',   cat), label: 'ai',   alt: autoAlt(aEnt) }
          ]
        });
      }
    }
    shuffle(rounds);
    return rounds;
  }

  // show broken URLs so you can click them
  async function preload(rounds){
    const failures = [];
    const tasks = [];
    for(const r of rounds){
      for(const img of r.images){
        tasks.push(new Promise(res=>{
          const im = new Image();
          im.onload = res;
          im.onerror = () => { failures.push(img.src); res(); };
          im.src = img.src;
        }));
      }
    }
    await Promise.all(tasks);
    el.error.innerHTML = failures.length
      ? 'Some images failed:<br>' + failures.map(u=>`<a style="color:#9bd2ff" href="${u}" target="_blank" rel="noreferrer">${u}</a>`).join('<br>')
      : '';
  }

  start();
  async function start(){
    try{
      const res = await fetch(toURL('images/manifest.json'), { cache:'no-store' });
      if(!res.ok) throw new Error(`Could not load images/manifest.json (HTTP ${res.status})`);
      const manifest = await res.json();
      state.rounds = buildRoundsFromCategorizedManifest(manifest);
      if (!state.rounds.length) throw new Error('No playable rounds found in manifest.');
      await preload(state.rounds);
      resetGame();
    }catch(err){
      el.error.textContent = err.message;
      console.error(err);
    }
  }

  function resetGame(){ state.i=0; state.score=0; state.picked=null; if(el.restart) el.restart.style.display='none'; render(); updateMeta(); }
  function current(){ return state.rounds[state.i]; }
  function updateMeta(){
    el.score.textContent = `Score: ${state.score}`;
    el.round.textContent = `Round: ${Math.min(state.i+1,state.rounds.length)} / ${state.rounds.length}`;
    const pct = state.rounds.length ? Math.round((state.i)/state.rounds.length*100) : 0;
    el.progress.style.width = pct + '%';
    el.progress.parentElement?.setAttribute('aria-valuenow', String(pct));
  }

  function render(){
    const r = current();
    if(!r){
      el.cards.innerHTML=''; el.status.innerHTML=`<strong>All done!</strong> You scored ${state.score} / ${state.rounds.length}.`;
      el.categoryNote.textContent=''; el.reveal.disabled=true; el.next.disabled=true; if(el.restart) el.restart.style.display='inline-block';
      el.progress.style.width='100%'; return;
    }
    let order=[0,1]; if(state.shuffleSides) shuffle(order);
    el.cards.innerHTML=''; el.error.textContent=''; el.status.textContent=`Round ${state.i+1}`; el.categoryNote.textContent=`Category: ${r.category}`;
    state.picked=null; el.reveal.disabled=false; el.next.disabled=true;

    order.forEach((srcIdx, visIdx)=>{
      const img=r.images[srcIdx];
      const card=document.createElement('button'); card.className='card'; card.type='button';
      card.dataset.visualIndex=String(visIdx); card.dataset.srcIndex=String(srcIdx);
      const label=document.createElement('div'); label.className='label'; label.textContent=visIdx===0?'A':'B';
      const frame=document.createElement('div'); frame.className='frame';
      const tag=document.createElement('img'); tag.src=img.src; tag.alt=img.alt; frame.appendChild(tag);
      const pick=document.createElement('div'); pick.className='pick';
      const guess=document.createElement('button'); guess.className='btn'; guess.type='button'; guess.textContent='This is AI';
      guess.addEventListener('click',e=>{e.stopPropagation(); choose(visIdx);}); pick.appendChild(guess);
      const overlay=document.createElement('div'); overlay.className='reveal'; overlay.innerHTML=`<span class="chip">${img.label.toUpperCase()}</span>`;
      card.append(label,frame,pick,overlay); card.addEventListener('click',()=>choose(visIdx));
      el.cards.appendChild(card);
    });

    window.onkeydown = (e)=>{ const k=e.key.toLowerCase(); if(k==='a')choose(0); if(k==='b')choose(1); if(k==='r')doReveal(); if(k==='n')doNext(); };
    updateMeta();
  }

  function choose(visIdx){
    if(!current()) return;
    el.cards.querySelectorAll('.card').forEach(c=>c.style.borderColor='var(--ring)');
    const card=el.cards.querySelector(`.card[data-visual-index="${visIdx}"]`); if(!card) return;
    state.picked=visIdx; card.style.borderColor='var(--accent)'; el.status.textContent=`Selected ${visIdx===0?'A':'B'}. Click Reveal or press R.`;
  }

  function doReveal(){
    const r=current(); if(!r) return;
    if(state.picked==null){ el.error.textContent='Pick an image first.'; return; }
    el.error.textContent='';
    const card=el.cards.querySelector(`.card[data-visual-index="${state.picked}"]`);
    const selectedSrcIdx=Number(card?.dataset.srcIndex||0);
    const pickedIsAI = r.images[selectedSrcIdx].label==='ai';
    const aiSrcIdx = r.images.findIndex(i=>i.label==='ai');
    const aiVisualIdx = Number(el.cards.querySelector(`.card[data-src-index="${aiSrcIdx}"]`)?.dataset.visualIndex||0);
    el.cards.querySelectorAll('.card').forEach(c=>{
      const ov=c.querySelector('.reveal'); ov.classList.add('show');
      const thisIsAI = Number(c.dataset.visualIndex)===aiVisualIdx;
      c.style.borderColor = thisIsAI ? 'var(--win)' : 'var(--ring)';
    });
    if(pickedIsAI){ state.score++; el.status.innerHTML='<strong>Correct!</strong> You picked the AI image.'; }
    else{ el.status.innerHTML='<strong>Not quite.</strong> The other image is AI.'; }
    el.score.textContent=`Score: ${state.score}`; el.reveal.disabled=true; el.next.disabled=false;
  }

  function doNext(){ if(!current()) return; state.i++; render(); }

  // wire buttons
  $('#revealBtn')?.addEventListener('click', doReveal);
  $('#nextBtn')?.addEventListener('click', doNext);
  $('#restartBtn')?.addEventListener('click', resetGame);
})();
</script>
