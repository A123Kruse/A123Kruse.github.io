<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI or Real? ‚Äî Game</title>

    <link rel="stylesheet" href="styles/site.css">
    <link rel="stylesheet" href="styles/streak.css">
</head>

<body>
    <div class="app">
        <header>
            <a class="link" href="index.html">‚Üê Home</a>
            <div class="title">AI or Real? ‚Äî Game</div>
            <div class="meta" aria-live="polite">
                <span class="pill" id="scorePill">Score: 0</span>
                <span class="pill" id="roundPill">Round: ‚Äì</span>
                <span class="pill" id="catPill" style="display:none"></span>
            </div>
        </header>

        <div class="bar"><div id="progress"></div></div>
        <p class="small">Pick the image that was generated by AI. Keys: <b>A</b>/<b>B</b> select, <b>R</b> reveal, <b>N</b> next.</p>

        <main class="board">
            <div id="status" class="small"></div>
            <div id="cards" class="cards"></div>

            <div class="controls">
                <button id="revealBtn" class="btn-main" disabled>Reveal</button>
                <div>
                    <button id="nextBtn" class="btn-main" disabled>Next</button>
                    <button id="restartBtn" class="btn-main" style="display:none">Restart</button>
                </div>
            </div>

            <div id="error" class="error"></div>
        </main>

        <!-- streak popup -->
        <div id="streakPop" class="streak-pop" aria-live="polite" hidden>
            <div class="toast">üî• Streak √ó<span id="streakCount">3</span> ‚Äî amazing! üéâ</div>
            <div class="confetti"></div>
        </div>

        <!-- Guard: toast + Next button -->
        <script>
            console.log('[guard] v2 loaded');

            // Simple fallback toast so __toast never throws
            window.__toast = (n = 3) => {
                const pop = document.getElementById('streakPop');
                const conf = pop?.querySelector('.confetti');
                const count = document.getElementById('streakCount');
                if (!pop || !conf) return console.warn('[toast] popup not found');
                if (count) count.textContent = String(n);
                conf.innerHTML = '';
                for (let i = 0; i < 36; i++) {
                    const piece = document.createElement('i');
                    piece.style.setProperty('--x', (5 + Math.random() * 90).toFixed(2));
                    piece.style.setProperty('--t', String(900 + Math.random() * 700));
                    piece.style.setProperty('--d', String(Math.random() * 350));
                    conf.appendChild(piece);
                }
                pop.hidden = true; pop.hidden = false; void pop.offsetWidth;
                pop.classList.add('show');
                setTimeout(() => { pop.classList.remove('show'); setTimeout(() => { pop.hidden = true; conf.innerHTML = ''; }, 220); }, 1400);
            };

            // Make Next button trigger the same logic as pressing "N"
            window.addEventListener('DOMContentLoaded', () => {
                const next = document.getElementById('nextBtn');
                if (next)
                    next.addEventListener('click', () =>
                        window.dispatchEvent(new KeyboardEvent('keydown', { key: 'n' }))
                    );
            });

            // Global error logger for sanity
            window.addEventListener('error', (e) => {
                const box = document.getElementById('error');
                if (box)
                    box.textContent = `${e.message} @ ${e.filename?.split('/').pop()}:${e.lineno}`;
                console.error('[boot error]', e.error || e.message, e);
            });
        </script>

        <!-- your main game script (unchanged logic) -->
        <script>
            (function () {
                console.log('[game] inline script started');
                const $ = (s, r = document) => r.querySelector(s);
                const el = {
                    cards: $('#cards'),
                    progress: $('#progress'),
                    score: $('#scorePill'),
                    round: $('#roundPill'),
                    reveal: $('#revealBtn'),
                    next: $('#nextBtn'),
                    restart: $('#restartBtn'),
                    status: $('#status'),
                    error: $('#error'),
                    streakPop: $('#streakPop'),
                    streakCount: $('#streakCount')
                };
                const state = { rounds: [], i: 0, score: 0, picked: null, aiStreak: 0, bestStreak: 0, breakdown: {} };

                async function start() {
                    try {
                        const res = await fetch('images/manifest.json', { cache: 'no-store' });
                        if (!res.ok) throw new Error('manifest load fail');
                        const m = await res.json();
                        const cats = Object.keys(m);
                        const rounds = [];
                        for (const cat of cats) {
                            const real = [...(m[cat]?.real || [])];
                            const ai = [...(m[cat]?.ai || [])];
                            const n = Math.min(real.length, ai.length);
                            for (let i = 0; i < n; i++) {
                                rounds.push({
                                    category: cat, images: [
                                        { src: `images/real/${cat}/${real[i]}`, label: 'real' },
                                        { src: `images/ai/${cat}/${ai[i]}`, label: 'ai' }]
                                });
                            }
                        }
                        state.rounds = rounds.sort(() => Math.random() - 0.5);
                        render();
                    } catch (e) {
                        el.error.textContent = e.message;
                    }
                }

                function render() {
                    const r = state.rounds[state.i];
                    if (!r) return;
                    el.cards.innerHTML = '';
                    ['A', 'B'].forEach((lbl, idx) => {
                        const card = document.createElement('button');
                        card.className = 'card';
                        card.innerHTML = `<div class="label">${lbl}</div><div class="frame"><img src="${r.images[idx].src}" alt=""></div><div class="reveal"><span class="chip">${r.images[idx].label.toUpperCase()}</span></div>`;
                        card.addEventListener('click', () => { state.picked = idx; el.reveal.disabled = false; });
                        el.cards.appendChild(card);
                    });
                    el.reveal.disabled = true;
                    el.next.disabled = true;
                }

                function doReveal() {
                    const r = state.rounds[state.i];
                    if (state.picked == null) return;
                    const correct = r.images[state.picked].label === 'ai';
                    if (correct) { state.score++; state.aiStreak++; } else { state.aiStreak = 0; }
                    el.score.textContent = `Score: ${state.score}`;
                    el.cards.querySelectorAll('.reveal').forEach(r => r.classList.add('show'));
                    el.next.disabled = false;
                    if (state.aiStreak >= 3) fireStreakToast(state.aiStreak);
                }

                function doNext() {
                    if (state.i >= state.rounds.length - 1) return;
                    state.i++; render();
                }

                function fireStreakToast(count) {
                    const pop = el.streakPop, conf = pop.querySelector('.confetti');
                    if (!pop || !conf) return;
                    el.streakCount.textContent = count;
                    conf.innerHTML = '';
                    for (let i = 0; i < 40; i++) {
                        const p = document.createElement('i');
                        p.style.setProperty('--x', (5 + Math.random() * 90).toFixed(2));
                        p.style.setProperty('--t', String(900 + Math.random() * 700));
                        p.style.setProperty('--d', String(Math.random() * 350));
                        conf.appendChild(p);
                    }
                    pop.hidden = true; pop.hidden = false; void pop.offsetWidth;
                    pop.classList.add('show');
                    setTimeout(() => { pop.classList.remove('show'); setTimeout(() => { pop.hidden = true; conf.innerHTML = ''; }, 220); }, 1400);
                }

                window.__fireStreakToast = fireStreakToast;
                window.__toast = fireStreakToast;

                el.reveal.addEventListener('click', doReveal);
                el.next.addEventListener('click', doNext);
                start();
            })();
        </script>
    </div>
</body>
</html>
